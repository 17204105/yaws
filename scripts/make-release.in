#!/bin/bash

# To create a new release of Yaws :
#
#     1) Be sure to have committed all your changes
#     2) Update Yaws version in vsn.mk. The new version must not match an existing tag
#     3) Execute this script

SRCDIR=@abs_top_srcdir@
BUILDDIR=@abs_top_builddir@

. ${SRCDIR}/vsn.mk
TAG="yaws-${YAWS_VSN}"

echo "packing release ${YAWS_VSN}"

BRANCH=$(cd ${SRCDIR} && git rev-parse --abbrev-ref HEAD)
if test "${BRANCH}" != "master"; then
    echo "ERROR: You need to be in the master branch to create a release";
    exit 1;
fi

(cd ${SRCDIR} && git status --porcelain | grep vsn.mk)
if test $? -ne 0; then
    echo "ERROR: vsn.mk file has not changed. Upgrade yaws version to proceed"
    exit 1
fi

(cd ${SRCDIR} && git show-ref --quiet ${TAG})
if test $? -eq 0; then
    echo "ERROR: tag ${TAG} already exists"
    exit 1
fi

(cd ${SRCDIR} && git status --porcelain | grep -v vsn.mk)
if test $? -eq 0; then
    echo "ERROR: you have unstaged/uncommitted changes"
    exit 1
fi

# Prepare release: Add vsn.mk and commit
(cd ${SRCDIR} && git add vsn.mk)
(cd ${SRCDIR} && git commit -m "Prepare release ${YAWS_VSN}")
if test $? -ne 0; then
    echo "ERROR: failed to commit vsn.mk for ${YAWS_VSN}"
    exit 1
fi
echo "   * prepare release ${TAG}                   [OK]"
# create release tags
(cd ${SRCDIR} && git tag -f -a -m "version ${YAWS_VSN}" ${TAG})
if test $? -ne 0; then
    echo "ERROR: failed to create tag ${TAG}"
    exit 1
fi

# generate the release changelog/news
(cd ${SRCDIR}/scripts && make changelog)
if test $? -ne 0; then
    echo "ERROR: failed to generate changelogs for ${TAG}"
    exit 1
fi
echo "   * Generate changelogs for ${TAG}           [OK]"

(cd ${SRCDIR}/scripts && make news)
if test $? -ne 0; then
    echo "ERROR: failed to generate news for ${TAG}"
    exit 1
fi
echo "   * Generate news for ${TAG}                 [OK]"

(cd ${SRCDIR}/scripts && make gh-contributors)
if test $? -ne 0; then
    echo "ERROR: failed to generate gh-contributor list for ${TAG}"
    exit 1
fi
echo "   * Generate gh-contributor list for ${TAG}  [OK]"

(cd ${SRCDIR} && git add www/changelogs www/news www/gh-contributors.txt)
(cd ${SRCDIR} && git commit -m "release ${YAWS_VSN}")
if test $? -ne 0; then
    echo "ERROR: failed to commit changelogs and news for ${TAG}"
    exit 1
fi

# update release tags
(cd ${SRCDIR} && git tag -f -a -m "version ${YAWS_VSN}" ${TAG})
if test $? -ne 0; then
    echo "ERROR: failed to update tag ${TAG}"
    exit 1
fi
echo "   * release ${TAG}                           [OK]"
echo
echo
echo "====================================================================="
echo
echo "Yaws ${YAWS_VSN} is released:"
echo "  - To create a dist tarball: make dist"
echo "  - To create a windows installer: make mkinstall INSTALL_BUILDER=..."
echo "  - To publish the release: git push --follow-tags"
echo
echo "====================================================================="
echo

exit 0
